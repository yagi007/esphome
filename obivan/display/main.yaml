# =============================================================================
# LVGL GUI Configuration for Victron Energy Monitoring
# Based on bennydiamond/esphome_lvgl_hmi_garage structure
# Optimized for caravan/motorhome offline operation
# Resolution: 800x480 (7" touch display)
# =============================================================================
font: !include fonts.yaml

# Packages pro modulární stránky - podle bennydiamond struktury
packages:
  page_bootscreen: !include pages/bootscreen.yaml
  page_overview: !include pages/overview.yaml
  page_mppt: !include pages/mppt.yaml
  page_dcdc: !include pages/dcdc.yaml
  page_system: !include pages/system.yaml
  bootscreen_scripts: !include scripts/bootscreen.yaml
  boot_scripts: !include boot.yaml

# Časovač pro aktualizace (šetrný s baterií)
interval:
  - interval: 30s
    # Častější aktualizace pro responzivní UI (pouze když je displej aktivní)
    then:
      - if:
          condition:
            and:
              - switch.is_on: lcdbacklight
              - lambda: "return !id(manual_display_off);"
              #- lambda: "return !id(aggressive_power_saving);"
          then:
            - script.execute: update_main_dashboard
          else:
            - logger.log: "Skipping main dashboard update - display is off for power saving"

  - interval: 60s # Méně časté aktualizace data náročných operací (pouze když je displej aktivní)
    then:
      - if:
          condition:
            and:
              - switch.is_on: lcdbacklight
              - lambda: "return !id(manual_display_off);"
              # - lambda: "return !id(aggressive_power_saving);"
          then:
            - script.execute: update_datetime
          else:
            - logger.log: "Skipping datetime update - display is off for power saving"

  # BLE interval disabled - BLE is now controlled only by screen_on/screen_off modes
  # This prevents unwanted BLE restarts that were consuming ~40mA during screen-off

# LVGL idle timeouts pro automatické screen-off a deep sleep
lvgl:
  on_idle:
    - timeout: 300s # Screen off po 30 sekundách nečinnosti
      then:
        - logger.log: "LVGL idle 30s - turning off screen"
        - script.execute: screen_off_mode
        - globals.set:
            id: manual_display_off
            value: "true"

    - timeout: !lambda "return id(deep_sleep_timeout) * 1000;" # Konfigurovateľný deep sleep timeout
      then:
        - if:
            condition:
              lambda: "return id(deep_sleep_timeout) > 0;"
            then:
              - logger.log:
                  format: "LVGL idle %ds - preparing deep sleep"
                  args: ["id(deep_sleep_timeout)"]
              - script.execute: prepare_deep_sleep
            else:
              - logger.log: "Deep sleep disabled - staying in screen off mode"

# Scripts pro aktualizace dat
script:
  - id: update_datetime
    then:
      # Hlavní header (ostatní stránky zdědí přes modulární komponentu se svými IDs)
      - lvgl.label.update:
          id: header_time
          text: !lambda |-
            auto now = id(sntp_time).now();
            static char time_buf[16];
            snprintf(time_buf, sizeof(time_buf), "%02d:%02d", now.hour, now.minute);
            return time_buf;
      - lvgl.label.update:
          id: header_date
          text: !lambda |-
            auto now = id(sntp_time).now();
            static char date_buf[16];
            snprintf(date_buf, sizeof(date_buf), "%02d.%02d", now.day_of_month, now.month);
            return date_buf;

  - id: update_device_status
    then:
      # Overview page
      - lvgl.label.update:
          id: status_shunt
          text_color: !lambda |-
            bool connected = id(shunt_battery_voltage).has_state() && !isnan(id(shunt_battery_voltage).state);
            return connected ? lv_color_hex(${icon_color_on}) : lv_color_hex(${icon_color_off});
      - lvgl.label.update:
          id: status_mppt
          text_color: !lambda |-
            bool connected = id(mppt_battery_voltage).has_state() && !isnan(id(mppt_battery_voltage).state);
            return connected ? lv_color_hex(${icon_color_on}) : lv_color_hex(${icon_color_off});
      - lvgl.label.update:
          id: status_orion
          text_color: !lambda |-
            bool connected = id(xs_input_voltage).has_state() && !isnan(id(xs_input_voltage).state);
            return connected ? lv_color_hex(${icon_color_on}) : lv_color_hex(${icon_color_off});
      # MPPT page
      - lvgl.label.update:
          id: mppt_status_shunt
          text_color: !lambda |-
            bool connected = id(shunt_battery_voltage).has_state() && !isnan(id(shunt_battery_voltage).state);
            return connected ? lv_color_hex(${icon_color_on}) : lv_color_hex(${icon_color_off});
      - lvgl.label.update:
          id: mppt_status_mppt
          text_color: !lambda |-
            bool connected = id(mppt_battery_voltage).has_state() && !isnan(id(mppt_battery_voltage).state);
            return connected ? lv_color_hex(${icon_color_on}) : lv_color_hex(${icon_color_off});
      - lvgl.label.update:
          id: mppt_status_orion
          text_color: !lambda |-
            bool connected = id(xs_input_voltage).has_state() && !isnan(id(xs_input_voltage).state);
            return connected ? lv_color_hex(${icon_color_on}) : lv_color_hex(${icon_color_off});
      # DC/DC page
      - lvgl.label.update:
          id: dcdc_status_shunt
          text_color: !lambda |-
            bool connected = id(shunt_battery_voltage).has_state() && !isnan(id(shunt_battery_voltage).state);
            return connected ? lv_color_hex(${icon_color_on}) : lv_color_hex(${icon_color_off});
      - lvgl.label.update:
          id: dcdc_status_mppt
          text_color: !lambda |-
            bool connected = id(mppt_battery_voltage).has_state() && !isnan(id(mppt_battery_voltage).state);
            return connected ? lv_color_hex(${icon_color_on}) : lv_color_hex(${icon_color_off});
      - lvgl.label.update:
          id: dcdc_status_orion
          text_color: !lambda |-
            bool connected = id(xs_input_voltage).has_state() && !isnan(id(xs_input_voltage).state);
            return connected ? lv_color_hex(${icon_color_on}) : lv_color_hex(${icon_color_off});
      # System page
      - lvgl.label.update:
          id: system_status_shunt
          text_color: !lambda |-
            bool connected = id(shunt_battery_voltage).has_state() && !isnan(id(shunt_battery_voltage).state);
            return connected ? lv_color_hex(${icon_color_on}) : lv_color_hex(${icon_color_off});
      - lvgl.label.update:
          id: system_status_mppt
          text_color: !lambda |-
            bool connected = id(mppt_battery_voltage).has_state() && !isnan(id(mppt_battery_voltage).state);
            return connected ? lv_color_hex(${icon_color_on}) : lv_color_hex(${icon_color_off});
      - lvgl.label.update:
          id: system_status_orion
          text_color: !lambda |-
            bool connected = id(xs_input_voltage).has_state() && !isnan(id(xs_input_voltage).state);
            return connected ? lv_color_hex(${icon_color_on}) : lv_color_hex(${icon_color_off});

  - id: update_wifi_status
    then:
      # Overview page WiFi status
      - lvgl.label.update:
          id: wifi_status
          text: !lambda |-
            if (!id(wifi_enabled)) return "\U000F05AA"; // WiFi off icon
            if (!id(wifi_rssi).has_state()) return "\U000F05AA"; // WiFi off - no signal data
            float rssi = id(wifi_rssi).state;
            if (rssi > -50) return "\U000F0928"; // Excellent signal
            if (rssi > -60) return "\U000F0925"; // Good signal
            if (rssi > -70) return "\U000F0922"; // Fair signal
            if (rssi > -80) return "\U000F091F"; // Poor signal
            return "\U000F092D"; // Weak signal
          text_color: !lambda |-
            if (!id(wifi_enabled)) return lv_color_hex(${icon_color_off});
            if (!id(wifi_rssi).has_state()) return lv_color_hex(${icon_color_off});
            float rssi = id(wifi_rssi).state;
            if (rssi > -50) return lv_color_hex(0x4CAF50); // Green - excellent
            if (rssi > -60) return lv_color_hex(0x8BC34A); // Light green - good
            if (rssi > -70) return lv_color_hex(0xFF9800); // Orange - fair
            if (rssi > -80) return lv_color_hex(0xFF0000); // RED - poor
            return lv_color_hex(0xFF5722); // Red - weak
      # MPPT page WiFi status
      - lvgl.label.update:
          id: mppt_wifi_status
          text: !lambda |-
            if (!id(wifi_enabled)) return "\U000F05AA";
            if (!id(wifi_rssi).has_state()) return "\U000F05AA";
            float rssi = id(wifi_rssi).state;
            if (rssi > -50) return "\U000F0928"; // Excellent signal
            if (rssi > -60) return "\U000F0925"; // Good signal
            if (rssi > -70) return "\U000F0922"; // Fair signal
            if (rssi > -80) return "\U000F091F"; // Poor signal
            return "\U000F092D"; // Weak signal
          text_color: !lambda |-
            if (!id(wifi_enabled)) return lv_color_hex(${icon_color_off});
            if (!id(wifi_rssi).has_state()) return lv_color_hex(${icon_color_off});
            float rssi = id(wifi_rssi).state;
            if (rssi > -50) return lv_color_hex(0x4CAF50);
            if (rssi > -60) return lv_color_hex(0x8BC34A);
            if (rssi > -70) return lv_color_hex(0xFF9800);
            if (rssi > -70) return lv_color_hex(0xFF0000);
            return lv_color_hex(0xFF5722);
      # DC/DC page WiFi status
      - lvgl.label.update:
          id: dcdc_wifi_status
          text: !lambda |-
            if (!id(wifi_enabled)) return "\U000F05AA";
            if (!id(wifi_rssi).has_state()) return "\U000F05AA";
            float rssi = id(wifi_rssi).state;
            if (rssi > -50) return "\U000F0928"; // Excellent signal
            if (rssi > -60) return "\U000F0925"; // Good signal
            if (rssi > -70) return "\U000F0922"; // Fair signal
            if (rssi > -80) return "\U000F091F"; // Poor signal
            return "\U000F092D"; // Weak signal
          text_color: !lambda |-
            if (!id(wifi_enabled)) return lv_color_hex(${icon_color_off});
            if (!id(wifi_rssi).has_state()) return lv_color_hex(${icon_color_off});
            float rssi = id(wifi_rssi).state;
            if (rssi > -50) return lv_color_hex(0x4CAF50);
            if (rssi > -60) return lv_color_hex(0x8BC34A);
            if (rssi > -70) return lv_color_hex(0xFF9800);
            if (rssi > -70) return lv_color_hex(0xFF0000);
            return lv_color_hex(0xFF5722);
      # System page WiFi status
      - lvgl.label.update:
          id: system_wifi_status
          text: !lambda |-
            if (!id(wifi_enabled)) return "\U000F05AA";
            if (!id(wifi_rssi).has_state()) return "\U000F05AA";
            float rssi = id(wifi_rssi).state;
            if (rssi > -50) return "\U000F0928"; // Excellent signal
            if (rssi > -60) return "\U000F0925"; // Good signal
            if (rssi > -70) return "\U000F0922"; // Fair signal
            if (rssi > -80) return "\U000F091F"; // Poor signal
            return "\U000F092D"; // Weak signal
          text_color: !lambda |-
            if (!id(wifi_enabled)) return lv_color_hex(${icon_color_off});
            if (!id(wifi_rssi).has_state()) return lv_color_hex(${icon_color_off});
            float rssi = id(wifi_rssi).state;
            if (rssi > -50) return lv_color_hex(0x4CAF50);
            if (rssi > -60) return lv_color_hex(0x8BC34A);
            if (rssi > -70) return lv_color_hex(0xFF9800);
            if (rssi > -80) return lv_color_hex(0xFF0000); // RED - poor
            return lv_color_hex(0xFF5722);

      # Update WiFi toggle button in system page
      - lambda: |-
          // Update WiFi toggle button status
          if (id(wifi_enabled)) {
            lv_obj_set_style_bg_color(id(wifi_toggle_btn), lv_color_hex(0x4CAF50), LV_PART_MAIN);
            lv_label_set_text(id(wifi_btn_label), "ZAPNUTO");
            ESP_LOGI("wifi_ui", "WiFi toggle button updated to ENABLED state");
          } else {
            lv_obj_set_style_bg_color(id(wifi_toggle_btn), lv_color_hex(0xFF5722), LV_PART_MAIN);
            lv_label_set_text(id(wifi_btn_label), "VYPNUTO");
            ESP_LOGI("wifi_ui", "WiFi toggle button updated to DISABLED state");
          }

  - id: update_battery_data
    then:
      # Battery gauge fill width and color
      - lvgl.widget.update:
          id: battery_gauge_fill
          width: !lambda |-
            float soc = id(shunt_soc).has_state() ? id(shunt_soc).state : 0;
            /* bg width = 204, padding none */
            int w = (int)(fmaxf(0.0f, fminf(soc, 100.0f)) * 204.0f / 100.0f);
            return w;
          bg_color: !lambda |-
            float soc = id(shunt_soc).has_state() ? id(shunt_soc).state : 0;
            if (soc > 50) return lv_color_hex(0x4CAF50);
            else if (soc > 20) return lv_color_hex(0xFF9800);
            else return lv_color_hex(0xF44336);
      - lvgl.label.update:
          id: soc_percentage
          text: !lambda |-
            float soc = id(shunt_soc).has_state() ? id(shunt_soc).state : 0;
            static char soc_buf[8];
            snprintf(soc_buf, sizeof(soc_buf), "%.0f%%", soc);
            return soc_buf;
          text_color: 0xFFFFFF
      - lvgl.label.update:
          id: battery_voltage
          text: !lambda |-
            float v = id(shunt_battery_voltage).has_state() ? id(shunt_battery_voltage).state : 0.0;
            static char buf[16];
            if (v >= 100) snprintf(buf, sizeof(buf), "%.0fV", v);
            else snprintf(buf, sizeof(buf), "%.1fV", v);
            return buf;
      - lvgl.label.update:
          id: battery_current
          text: !lambda |-
            float a = id(shunt_battery_current).has_state() ? id(shunt_battery_current).state : 0.0;
            static char buf[16];
            if (fabs(a) >= 100) snprintf(buf, sizeof(buf), "%.0fA", a);
            else snprintf(buf, sizeof(buf), "%.1fA", a);
            return buf;
          text_color: !lambda |-
            float current = id(shunt_battery_current).has_state() ? id(shunt_battery_current).state : 0;
            if (current > 0.1) return lv_color_hex(0x4CAF50);
            else if (current < -0.1) return lv_color_hex(0xFF5722);
            else return lv_color_hex(0xCCCCCC);
      - lvgl.label.update:
          id: battery_power
          text: !lambda |-
            float w = id(shunt_battery_power).has_state() ? id(shunt_battery_power).state : 0.0;
            static char buf[16];
            if (fabs(w) >= 1000) snprintf(buf, sizeof(buf), "%.1fkW", w/1000);
            else snprintf(buf, sizeof(buf), "%.0fW", w);
            return buf;
          text_color: !lambda |-
            float power = id(shunt_battery_power).has_state() ? id(shunt_battery_power).state : 0;
            if (power > 1) return lv_color_hex(0x4CAF50);
            else if (power < -1) return lv_color_hex(0xFF5722);
            else return lv_color_hex(0xCCCCCC);
      - lvgl.label.update:
          id: battery_remaining
          text: !lambda |-
            float ttg = id(shunt_time_to_go).has_state() ? id(shunt_time_to_go).state : 0;
            static char ttg_buf[16];
            if (ttg >= 1440) {
              snprintf(ttg_buf, sizeof(ttg_buf), "%.0fd", ttg/1440);
            } else if (ttg >= 60) {
              snprintf(ttg_buf, sizeof(ttg_buf), "%.1fh", ttg/60);
            } else if (ttg > 0) {
              snprintf(ttg_buf, sizeof(ttg_buf), "%.0fmin", ttg);
            } else {
              snprintf(ttg_buf, sizeof(ttg_buf), "∞");
            }
            return ttg_buf;
      - lvgl.label.update:
          id: battery_capacity
          text: !lambda |-
            const float BATTERY_NOMINAL = 150.0;
            float consumed = id(shunt_consumed_ah).has_state() ? id(shunt_consumed_ah).state : 0;
            float remaining = BATTERY_NOMINAL - consumed;
            static char cap_buf[16];
            snprintf(cap_buf, sizeof(cap_buf), "%.0f/%.0fAh", remaining, BATTERY_NOMINAL);
            return cap_buf;

  - id: update_solar_data
    then:
      - lvgl.label.update:
          id: solar_pv_power
          text: !lambda |-
            float pv = id(mppt_pv_power).has_state() ? id(mppt_pv_power).state : 0.0;
            static char buf[16];
            if (pv >= 1000) snprintf(buf, sizeof(buf), "%.1fkW", pv/1000);
            else snprintf(buf, sizeof(buf), "%.0fW", pv);
            return buf;
      - lvgl.label.update:
          id: solar_battery_current
          text: !lambda |-
            float a = id(mppt_battery_current).has_state() ? id(mppt_battery_current).state : 0.0;
            static char buf[16];
            snprintf(buf, sizeof(buf), "> %.1fA", a);
            return buf;
      - lvgl.label.update:
          id: solar_yield_today
          text: !lambda |-
            float y = id(mppt_yield_today).has_state() ? id(mppt_yield_today).state : 0.0;
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.1fkWh", y);
            return buf;

  - id: update_dcdc_data
    then:
      - lvgl.label.update:
          id: dcdc_output_power
          text: !lambda |-
            float w = id(xs_output_power).has_state() ? id(xs_output_power).state : 0.0;
            static char buf[16];
            if (w >= 1000) snprintf(buf, sizeof(buf), "%.1fkW", w/1000);
            else snprintf(buf, sizeof(buf), "%.0fW", w);
            return buf;
      - lvgl.label.update:
          id: dcdc_output_current
          text: !lambda |-
            float a = id(xs_output_current).has_state() ? id(xs_output_current).state : 0.0;
            static char buf[16];
            snprintf(buf, sizeof(buf), "> %.1fA", a);
            return buf;
      - lvgl.label.update:
          id: dcdc_efficiency
          text: !lambda |-
            float in_power = id(xs_input_power).has_state() ? id(xs_input_power).state : 0.0;
            float out_power = id(xs_output_power).has_state() ? id(xs_output_power).state : 0.0;
            float efficiency = (in_power > 0) ? (out_power / in_power * 100) : 0;
            static char buf[8];
            snprintf(buf, sizeof(buf), "%.0f%%", efficiency);
            return buf;

  - id: update_load_data
    then:
      - lvgl.label.update:
          id: load_power
          text: !lambda |-
            float w = id(mppt_load_power).has_state() ? id(mppt_load_power).state : 0.0;
            static char buf[16];
            if (w >= 1000) snprintf(buf, sizeof(buf), "%.1fkW", w/1000);
            else snprintf(buf, sizeof(buf), "%.0fW", w);
            return buf;
      - lvgl.label.update:
          id: load_current
          text: !lambda |-
            float a = id(mppt_load_current).has_state() ? id(mppt_load_current).state : 0.0;
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.1fA <", a);
            return buf;
      - lvgl.label.update:
          id: load_daily
          text: !lambda |-
            float w = id(mppt_load_power).has_state() ? id(mppt_load_power).state : 0.0;
            float daily_estimate = (w * 24) / 1000.0;
            static char buf[16];
            snprintf(buf, sizeof(buf), "%.1fkWh", daily_estimate);
            return buf;

  - id: update_flows
    then:
      # Solar -> Battery
      - lvgl.widget.update:
          id: flow_solar_to_batt
          line_color: !lambda |-
            float pv = id(mppt_pv_power).has_state() ? id(mppt_pv_power).state : 0.0f;
            if (pv <= 1.0f) return lv_color_hex(0x666666);
            return lv_color_hex(0x4CAF50);
          line_width: !lambda |-
            float pv = id(mppt_pv_power).has_state() ? id(mppt_pv_power).state : 0.0f;
            int w = 2 + (int) fminf(fabsf(pv) / 100.0f, 8.0f);
            return w;
      - lvgl.widget.update:
          id: dot_solar_batt
          bg_color: !lambda |-
            float pv = id(mppt_pv_power).has_state() ? id(mppt_pv_power).state : 0.0f;
            if (pv <= 1.0f) return lv_color_hex(0x666666);
            return lv_color_hex(0x4CAF50);

      # DCDC -> Battery
      - lvgl.widget.update:
          id: flow_dcdc_to_batt
          line_color: !lambda |-
            float w = id(xs_output_power).has_state() ? id(xs_output_power).state : 0.0f;
            if (fabsf(w) <= 1.0f) return lv_color_hex(0x666666);
            return w >= 0 ? lv_color_hex(0x4CAF50) : lv_color_hex(0xFF5722);
          line_width: !lambda |-
            float w = id(xs_output_power).has_state() ? id(xs_output_power).state : 0.0f;
            int lw = 2 + (int) fminf(fabsf(w) / 100.0f, 8.0f);
            return lw;
      - lvgl.widget.update:
          id: dot_dcdc_batt
          bg_color: !lambda |-
            float w = id(xs_output_power).has_state() ? id(xs_output_power).state : 0.0f;
            if (fabsf(w) <= 1.0f) return lv_color_hex(0x666666);
            return w >= 0 ? lv_color_hex(0x4CAF50) : lv_color_hex(0xFF5722);

      # Battery -> Load (zatím dle SmartShunt: kladné = nabíjení, záporné = vybíjení)
      - lvgl.widget.update:
          id: flow_batt_to_load
          line_color: !lambda |-
            float a = id(shunt_battery_current).has_state() ? id(shunt_battery_current).state : 0.0f;
            if (fabsf(a) <= 0.1f) return lv_color_hex(0x666666);
            return a < -0.1f ? lv_color_hex(0xFF5722) : lv_color_hex(0x4CAF50);
          line_width: !lambda |-
            float a = id(shunt_battery_current).has_state() ? id(shunt_battery_current).state : 0.0f;
            int lw = 2 + (int) fminf(fabsf(a) / 5.0f, 8.0f);
            return lw;
      - lvgl.widget.update:
          id: dot_batt_load
          bg_color: !lambda |-
            float a = id(shunt_battery_current).has_state() ? id(shunt_battery_current).state : 0.0f;
            if (fabsf(a) <= 0.1f) return lv_color_hex(0x666666);
            return a < -0.1f ? lv_color_hex(0xFF5722) : lv_color_hex(0x4CAF50);

  - id: update_main_dashboard
    then:
      - script.execute: update_device_status
      - script.execute: update_battery_data
      - script.execute: update_solar_data
      - script.execute: update_dcdc_data
      - script.execute: update_load_data
      - script.execute: update_flows
      - script.execute: update_wifi_status
      # Wake display if LVGL paused (optional UX tweak)
      # - if:
      #     condition: lvgl.is_paused
      #     then:
      #       - lvgl.resume:
